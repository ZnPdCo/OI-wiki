(function(S,C){typeof exports=="object"&&typeof module<"u"?C(exports):typeof define=="function"&&define.amd?define(["exports"],C):(S=typeof globalThis<"u"?globalThis:S||self,C(S.OIWikiFeedbackSysFrontend={}))})(this,function(S){"use strict";const C='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11v2q0 .425.288.713T12 14t.713-.288T13 13v-2h2q.425 0 .713-.288T16 10t-.288-.712T15 9h-2V7q0-.425-.288-.712T12 6t-.712.288T11 7v2H9q-.425 0-.712.288T8 10t.288.713T9 11zm-5 7l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"/></svg>',Q='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M7 14h10q.425 0 .713-.288T18 13t-.288-.712T17 12H7q-.425 0-.712.288T6 13t.288.713T7 14m0-3h10q.425 0 .713-.288T18 10t-.288-.712T17 9H7q-.425 0-.712.288T6 10t.288.713T7 11m0-3h10q.425 0 .713-.288T18 7t-.288-.712T17 6H7q-.425 0-.712.288T6 7t.288.713T7 8M4 18q-.825 0-1.412-.587T2 16V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v15.575q0 .675-.612.938T20.3 20.3L18 18zm14.85-2L20 17.125V4H4v12zM4 16V4z"/></svg>',X='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"/></svg>',Y='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M5.85 17.1q1.275-.975 2.85-1.537T12 15t3.3.563t2.85 1.537q.875-1.025 1.363-2.325T20 12q0-3.325-2.337-5.663T12 4T6.337 6.338T4 12q0 1.475.488 2.775T5.85 17.1M12 13q-1.475 0-2.488-1.012T8.5 9.5t1.013-2.488T12 6t2.488 1.013T15.5 9.5t-1.012 2.488T12 13m0 9q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"/></svg>',Z=function(t,e){return t.reduce((a,i)=>((a[e(i)]=a[e(i)]||[]).push(i),a),{})},B=new Intl.DateTimeFormat("zh-CN",{dateStyle:"short",timeStyle:"short"});let N=!1,x="/api",r=null,o,R,v,I;const tt=async()=>{const t=await fetch(`${x}meta/github-app`,{method:"GET"});if(!t.ok)throw t;I||(I=(await t.json()).data)},et=()=>{const t=new URL(window.location.href),e=t.searchParams.get("oauth_token");e&&(document.cookie=`oauth_token=${e}; path=/; expires=${new Date(JSON.parse(atob(e.split(".")[1])).exp*1e3).toUTCString()}; secure`,t.searchParams.delete("oauth_token"),window.history.replaceState(null,"",t.toString()))},H=()=>document.cookie.replace(/(?:(?:^|.*;\s*)oauth_token\s*\=\s*([^;]*).*$)|^.*$/,"$1"),M=()=>{const t=H();if(!t)return;const e=atob(t.split(".")[1]);return JSON.parse(e)},V=()=>{document.cookie="oauth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; secure"},P=({id:t,content:e,actions:a=new Map,parent:i=document.body,insertPosition:s="afterend",tag:n="div",initialize:y=()=>{}})=>{let c=document.querySelector(`#${t}`);if(c)return c;i.insertAdjacentHTML(s,`
    <${n} id="${t}">
      ${e.trim()}
    </${n}>
    `.trim()),c=document.querySelector(`#${t}`),y(c);const w=c.querySelectorAll("[data-action]");for(const q of w)q.addEventListener("click",g=>{var L;g.stopPropagation();const A=g.currentTarget,b=A.dataset.action??"";(L=a.get(b))==null||L(A)});return c},U=({el:t,focusReply:e=!1})=>{r!==t&&(r==null||r.classList.remove("review_selected"),r=t),((r==null?void 0:r.classList.contains("review_has_comments"))===!0||e)&&(r.classList.remove("review_focused"),r.classList.add("review_selected"),T())},nt=()=>{r==null||r.classList.remove("review_selected"),r=null},ot=({el:t})=>{P({id:"review-context-menu",content:`
    <button data-action="comment">
      ${C}
    </button>
    `,parent:t,insertPosition:"beforeend",actions:new Map([["comment",e=>{var a;(a=e.parentElement)==null||a.remove(),U({el:t,focusReply:!0})}]]),initialize:e=>{e.addEventListener("mouseenter",()=>{t.classList.add("review_focused")}),e.addEventListener("mouseleave",()=>{t.classList.remove("review_focused")})}})},at=()=>{document.querySelector("#review-context-menu").remove()},T=async()=>{const t=[...await $()],e=r;e&&t.find(s=>s.offset.start===parseInt(e.dataset.originalDocumentStart)&&s.offset.end===parseInt(e.dataset.originalDocumentEnd))===void 0&&t.push({id:-1,offset:{start:parseInt(e.dataset.originalDocumentStart),end:parseInt(e.dataset.originalDocumentEnd)},commenter:{name:"",oauth_provider:"github",oauth_user_id:""},comment:"",created_time:new Date().toISOString(),last_edited_time:null,pending:!0}),rt(t);let a=document.querySelector(`#review-comments-panel .comments_group[data-original-document-start="${r==null?void 0:r.dataset.originalDocumentStart}"][data-original-document-end="${r==null?void 0:r.dataset.originalDocumentEnd}"]`);a==null||a.classList.add("review_selected"),a==null||a.scrollIntoView({behavior:"smooth",block:"start"});const i=a==null?void 0:a.querySelector(".comment_actions_panel textarea");i==null||i.focus(),R.classList.add("review_hidden"),v.classList.remove("review_hidden")},j=()=>{v.classList.add("review_hidden"),R.classList.remove("review_hidden")},it=async({offsets:t,content:e})=>{var c,w,q;const a=sessionStorage.getItem("commitHash");if(!a)throw new Error("找不到 Commit hash，请联系站点管理员");const i={offset:{start:t[0],end:t[1]},comment:e},s=fetch(`${x}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${H()}`},body:JSON.stringify({...i,commit_hash:a})}),n=(o==null?void 0:o.length)??-1;o&&o.push({...i,commenter:{name:((c=M())==null?void 0:c.name)??"未知用户",oauth_provider:(w=M())==null?void 0:w.provider,oauth_user_id:((q=M())==null?void 0:q.id)??"-1"},id:o.length,created_time:new Date().toISOString(),last_edited_time:null,pending:!0});const y=await s;if(!y.ok)throw o&&(o=o.filter(g=>g.id!==n)),y;o&&(o=o.map(g=>g.id===n?{...g,pending:!1}:g)),await $(!0),D()},st=async({id:t,comment:e})=>{const a=fetch(`${x}comment/${encodeURIComponent(new URL(window.location.href).pathname)}/id/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${H()}`},body:JSON.stringify({comment:e})});o&&(o=o.map(s=>s.id===t?{...s,pending:!0}:s));const i=await a;if(!i.ok)throw o&&(o=o.map(s=>s.id===t?{...s,pending:!1}:s)),i;o&&(o=o.map(s=>s.id===t?{...s,comment:e,pending:!1}:s)),await $(!0),D()},ct=async({id:t})=>{const e=fetch(`${x}comment/${encodeURIComponent(new URL(window.location.href).pathname)}/id/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${H()}`}});o&&(o=o.map(i=>i.id===t?{...i,pending:!0}:i));const a=await e;if(!a.ok)throw o&&(o=o.map(i=>i.id===t?{...i,pending:!1}:i)),a;o&&(o=o.filter(i=>i.id!==t)),await $(!0),D()},$=async(t=!1)=>{if(!t&&o)return o;const e=await fetch(`${x}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`);if(!e.ok)throw e;const a=(await e.json()).data;return o=a,a},rt=t=>{const e=v.querySelector(".panel_main"),a=document.createDocumentFragment(),i=Z(t,s=>`${s.offset.start}-${s.offset.end}`);for(const s of Object.keys(i).sort((n,y)=>parseInt(n.split("-")[0])-parseInt(y.split("-")[0]))){const n=document.createElement("div");n.classList.add("comments_group");const y=s.split("-");n.dataset.originalDocumentStart=y[0],n.dataset.originalDocumentEnd=y[1];const c=document.querySelector(`.review_enabled[data-original-document-start="${n.dataset.originalDocumentStart}"][data-original-document-end="${n.dataset.originalDocumentEnd}"]`),w=(c==null?void 0:c.textContent)??"";n.innerHTML=`
      <div class="comments_group_header">
        <span class="comments_group_text_content">${w}</span>
      </div>
      <div class="comments_group_main"></div>
      <div class="comments_group_footer">
        <div class="comment_actions_panel">
          <div class="comment_actions_header">
            <span class="comment_username"></span>
            <button class="comment_actions_item" data-action="logout">退出登录</button>
          </div>
          <textarea required placeholder="写下你的评论..."  autocapitalize="sentences" autocomplete="on" spellcheck="true" maxlength="65535"></textarea>
          <div class="comment_actions_footer">
            <span class="comment_actions_notification"></span>
            <div class="comment_actions comment_actions_login">
              <button class="comment_actions_item comment_actions_item_btn comment_actions_item_btn_primary" data-action="login">登录到 GitHub</button>
            </div>
            <div class="comment_actions comment_actions_modify">
              <button class="comment_actions_item comment_actions_item_btn" data-action="modify_cancel">取消</button>
              <button class="comment_actions_item comment_actions_item_btn comment_actions_item_btn_primary" data-action="modify_submit">修改</button>
            </div>
            <div class="comment_actions comment_actions_reply">
              <button class="comment_actions_item comment_actions_item_btn" data-action="cancel">取消</button>
              <button class="comment_actions_item comment_actions_item_btn comment_actions_item_btn_primary" data-action="submit">提交</button>
            </div>
          </div>
        </div>
      </div>
    `.trim(),n.querySelector(".comment_actions_panel textarea").addEventListener("input",l=>{const d=l.currentTarget;d.style.height="5px",d.style.height=d.scrollHeight+"px"});const q=n.querySelector(".comment_username"),g=n.querySelector(".comment_actions_login"),A=n.querySelector("button.comment_actions_item[data-action='logout']"),b=M();b?(q.textContent=`作为 ${b.name} 发表评论`,g.style.display="none"):(q.textContent="登录到 GitHub 以发表评论",A.style.display="none");const L=n.querySelector(".comment_actions_modify");L.style.display="none",n.addEventListener("mouseenter",()=>{c==null||c.classList.add("review_focused")}),n.addEventListener("mouseleave",()=>{c==null||c.classList.remove("review_focused")}),n.addEventListener("click",l=>{var d;l.stopPropagation(),r==null||r.classList.remove("review_selected"),c==null||c.classList.remove("review_focused"),c==null||c.classList.add("review_selected"),(d=document.querySelector(".comments_group.review_selected"))==null||d.classList.remove("review_selected"),n.classList.add("review_selected"),r=c,r==null||r.scrollIntoView({behavior:"smooth",block:"center"})});const dt=i[s].sort((l,d)=>new Date(l.created_time).getTime()-new Date(d.created_time).getTime()),lt=n.querySelector(".comments_group_main");for(const l of dt){if(l.id===-1)continue;const d=document.createElement("div");if(d.classList.add("comment"),l.pending&&d.classList.add("comment_pending"),d.dataset.id=l.id.toString(),d.innerHTML=`
        <div class="comment_container">
          <div class="comment_side">
            <div class="comment_user_avatar">
              <img src="${l.commenter.avatar_url}" alt="user avatar"/>
            </div>
          </div>
          <div class="comment_base">
            <div class="comment_header">
              <span class="comment_commenter"></span>
              <span class="comment_time comment_created_time">发布于 ${B.format(new Date(l.created_time))}</span>
              <span class="comment_time comment_edited_time">最后编辑于 ${l.last_edited_time?B.format(new Date(l.last_edited_time)):""}</span>
              <div class="comment_actions">
                <button class="comment_actions_item" data-action="modify">修改</button>
                <button class="comment_actions_item" data-action="delete">删除</button>
              </div>
            </div>
            <div class="comment_main">
              <span class="comment_content"></span>
              <span class="comment_edit_tag">(已编辑)</span>
            </div>
          </div>
        </div>
        <div class="comment_tailing">
          <button class="comment_actions_item comment_expand" data-action="expand">展开</button>
          <button class="comment_actions_item comment_expand" data-action="fold">折叠</button>
        </div>
      `.trim(),d.querySelector(".comment_commenter").textContent=l.commenter.name,d.querySelector(".comment_main .comment_content").textContent=l.comment,!l.commenter.avatar_url){const z=d.querySelector(".comment_user_avatar");z.innerHTML=Y}const f=d.querySelector(".comment_header .comment_actions");(!b||b.provider!==l.commenter.oauth_provider||b.id!==l.commenter.oauth_user_id)&&(f.style.display="none"),b&&b.isAdmin===!0&&(f.style.display=""),l.id===-1&&(f.style.display="none");const _=d.querySelector(".comment_header .comment_created_time"),u=d.querySelector(".comment_header .comment_edited_time");u.style.display="none",l.last_edited_time&&_.addEventListener("click",()=>{_.style.display="none",u.style.display=""}),u.addEventListener("click",()=>{_.style.display="",u.style.display="none"});const k=d.querySelector(".comment_main .comment_edit_tag");l.last_edited_time||(k.style.display="none"),lt.appendChild(d)}for(const l of n.querySelectorAll(".comment_actions_item"))l.addEventListener("click",d=>{var z,F,W,O,G;if(!(d.target instanceof HTMLButtonElement))return;const f=d.target,_=n.querySelector(".comment_actions_panel textarea"),u=n.querySelector(".comment_actions_notification"),k=async m=>{var p;if(console.error(m),m instanceof Error)u.textContent=m.message;else if(m instanceof Response){if(m.status===401){u.textContent="身份验证失效，请重新登录",V();return}if(((p=m.headers.get("content-type"))==null?void 0:p.includes("application/json"))===!0){const h=await m.json();u.textContent=h.error}else u.textContent=`未知接口错误：${m.status}(${m.statusText})`}else u.textContent="提交失败，请稍后再试"};switch(f==null?void 0:f.dataset.action){case"login":{if(!I){console.log("githubMeta not ready");return}window.location.href=`https://github.com/login/oauth/authorize?client_id=${I.client_id}&state=${encodeURIComponent(JSON.stringify({redirect:window.location.href}))}`;break}case"logout":{V(),window.location.reload();break}case"cancel":{_.disabled=!1,_.value="",u.textContent="";break}case"submit":{if(_.disabled=!0,!_.checkValidity()){u.textContent="请填写评论内容",_.disabled=!1;return}u.textContent="",it({offsets:[parseInt(r.dataset.originalDocumentStart),parseInt(r.dataset.originalDocumentEnd)],content:_.value}).then(()=>{_.value="",u.textContent=""}).catch(k).finally(()=>{T().then(()=>{const m=v.querySelector(".review_selected .comment_actions_notification"),p=v.querySelector(".review_selected .comment_actions_panel textarea");m&&(m.textContent=u.textContent),p&&(p.value=_.value)})}),T().then(()=>{const m=v.querySelector(".review_selected button[data-action='submit']");m&&(m.disabled=!0)});break}case"modify":{(z=n.querySelector(`.comment[data-id="${n.dataset.modifingId}"]`))==null||z.classList.remove("comment_pending"),f.dataset.tag="using";const m=n.querySelector(`.comment:has([data-tag="using"][data-action="${f==null?void 0:f.dataset.action}"])`);delete f.dataset.tag;const p=(F=m==null?void 0:m.dataset)==null?void 0:F.id;if(p==null)return;m==null||m.classList.add("comment_pending"),L.style.display="",n.dataset.modifingId=p,_.value=((W=o==null?void 0:o.find(h=>h.id===parseInt(p)))==null?void 0:W.comment)??"";break}case"modify_cancel":{(O=n.querySelector(`.comment[data-id="${n.dataset.modifingId}"]`))==null||O.classList.remove("comment_pending"),L.style.display="none",delete n.dataset.modifingId,_.disabled=!1,_.value="",u.textContent="";break}case"modify_submit":{const m=n.dataset.modifingId;if(m==null)return;st({id:parseInt(m),comment:_.value}).then(()=>{_.value="",u.textContent=""}).catch(k).finally(()=>{T().then(()=>{const p=v.querySelector(".review_selected .comment_actions_notification"),h=v.querySelector(".review_selected .comment_actions_panel textarea");p&&(p.textContent=u.textContent),h&&(h.value=_.value)})}),T();break}case"delete":{f.dataset.tag="using";const m=n.querySelector(`.comment:has([data-tag="using"][data-action="${f==null?void 0:f.dataset.action}"])`);delete f.dataset.tag;const p=(G=m.dataset)==null?void 0:G.id;if(p==null)return;ct({id:parseInt(p)}).catch(k).finally(()=>{T().then(()=>{const h=v.querySelector(".review_selected .comment_actions_notification"),E=v.querySelector(".review_selected .comment_actions_panel textarea");h&&(h.textContent=u.textContent),E&&(E.value=_.value)})}),T().then(()=>{const h=v.querySelector(".review_selected .comment_actions_notification"),E=v.querySelector(`.comment[data-id="${p}"] button[data-action="delete"]`),K=v.querySelector(`.comment[data-id="${p}"] button[data-action="modify"]`);h&&(h.textContent=u.textContent),E&&(E.disabled=!0),K&&(K.disabled=!0)});break}}});a.appendChild(n)}for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(a);for(const s of v.querySelectorAll(".comment")){const n=s.querySelector(".comment_main"),y=s.querySelector('.comment_tailing .comment_expand[data-action="expand"]'),c=s.querySelector('.comment_tailing .comment_expand[data-action="fold"]'),w=n.offsetHeight;n.scrollHeight<=w&&(y.style.display="none"),c.style.display="none",y.addEventListener("click",()=>{y.style.display="none",c.style.display="",n.style.maxHeight="100%",n.style.maxHeight=n.scrollHeight+"px"}),c.addEventListener("click",()=>{y.style.display="",c.style.display="none",n.style.maxHeight=`${w}px`})}},D=async()=>{const t=Array.from(document.querySelectorAll(".review_enabled[data-original-document-start][data-original-document-end]"));await $();for(let e of t)e.classList.remove("review_has_comments"),o.find(a=>a.offset.start===parseInt(e.dataset.originalDocumentStart)&&a.offset.end===parseInt(e.dataset.originalDocumentEnd))&&e.classList.add("review_has_comments")},J="0.5.1";function mt(t,{apiEndpoint:e="/api"}={}){x=e.endsWith("/")?e:e+"/",et();const a=Array.from(t.querySelectorAll("[data-original-document-start][data-original-document-end]"));if(!a){console.warn("oiwiki-feedback-sys-frontend not found any offsets to inject, quitting...");return}for(let i of a)i.classList.add("review_enabled"),i.addEventListener("click",s=>{s.stopPropagation(),U({el:s.currentTarget})}),i.addEventListener("mouseenter",s=>{ot({el:s.currentTarget})}),i.addEventListener("mouseleave",()=>{at()});if(o=void 0,D(),tt(),N){j(),console.log("oiwiki-feedback-sys-frontend has been successfully reset.");return}document.addEventListener("click",()=>{nt()}),R=P({id:"review-comments-button",content:`
    <button data-action="open">
      ${Q}
    </button>
    `,actions:new Map([["open",()=>T()]])}),v=P({id:"review-comments-panel",content:`
    <div class="panel_header">
      <span>本页评论</span>
      <button data-action="close">
        ${X}
      </button>
    </div>
    <div class="panel_main"></div>
    `,insertPosition:"beforeend",actions:new Map([["close",()=>j()]])}),j(),console.log(`oiwiki-feedback-sys-frontend version ${J} has been successfully installed.`),N=!0}S.__VERSION__=J,S.setupReview=mt,Object.defineProperty(S,Symbol.toStringTag,{value:"Module"})});
